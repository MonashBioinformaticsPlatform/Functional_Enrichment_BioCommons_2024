---
title: "WebGestaltR"
output: html_notebook
---


```{r  Load libraries, include=FALSE }
library(WebGestaltR)
library(readr)
library(dplyr)


#library(ReactomePA)
#library(clusterProfiler)
```











Focus on GO hierarchy and redundant terms: 
Run GO_MF regular vs GO_MF_nonRedudnant

Highlight the  differences - check the number of significant terms (either from R CLI or HTML report or both - plot venn, print out the unique terms

Focus on one of the unique terms, show what has been dropped from the non-redundant analysis and the parent-child hierarchy on GO. 

This neat feature of WebGestatlR saves using topGO or rrvgo
Drops the generic higher order parent terms so we have fewer more specific terms to focus on

~~~

# [WebgestaltR](https://cran.r-project.org/web/packages/WebGestaltR/WebGestaltR.pdf)

enrichMethod organism Enrichment methods: ORA, GSEA or NTA.
NTA = network topology analysis


LIST OF AMAZING THINGS ABOUT WEBGESTALTR:
- makes great html reports with interactive plots and links to external dbs
- saves the results to disk when running, no need to export stuf and save files manually 
- many dbs and gene lists supported (n = 70) 
- supports metabolomics, with 15 different ID types, see new paper https://academic.oup.com/nar/article/52/W1/W415/7684598#google_vignette 
- can be used for novel species, but i havent tried it yet... 
- does ORA, GSEA, and NTA. I wonder if the NTA works at all for novel species???! 
- super easy to run. many supported namespaces (n = 73), does not require conversions for different functions like clusterProfiler, can even have different napesapce for ORA gene list and background list 
- "Multiple databases in a vector are supported for ORA and GSEA" 

**Must add GO vs GO Slim!**

WebGestaltR supports 12 species directly, however, you can import your own database files to perform ORA and GSEA for novel species :-) 

From the user guide: "Users can also input 'others' to perform the enrichment analysis for other organisms not supported by WebGestaltR. For other organisms, users need to provide the functional categories, interesting list and reference list (for ORA method). Because WebGestaltR does not perform the ID mapping for the other organisms, the above data should have the same ID type" 

```{r view organisms }
listOrganism()
```



```{r list available namespace options}

listIdType()

```

```{r}
listIdType( organism = "cfamiliaris")
```
```{r}
listGeneSet(organism = "cfamiliaris")
```


WebGestaltR supports 70 databases!

Use ight arr wot vo view other columsn - there is also description and ID type 

```{r}
#enrichDatabase : The functional categories for the enrichment analysis. Users can use the function listGeneSet to check the available functional databases for the selected organism. Multiple databases in a vector are supported for ORA and GSEA
listGeneSet()

```

```{r}
# Get the list of gene sets
gene_sets_df <- listGeneSet()

# Extract the description for the desired gene set
description <- gene_sets_df$description[gene_sets_df$name == "geneontology_Molecular_Function_noRedundant"]

# Print the description
print(description)
```


# 1. Load input data and extract ranked gene list

We will use the same Pezzini RNAseq dataset as earlier. First, confirm your working directory is the `Functional_enrichment_workshop_2024/day_2` folder.

```{r setup, include=FALSE}
# Set the root directory for all notebook chunks

getwd()

```


Please ask for assistance if this step does not show the day_2 folder path!

Once your working directory is set, load the dataset and extract the gene lists.

```{r load input data}

# Full dataset
data <- read_tsv("Pezzini_DE.txt", col_names = TRUE, show_col_types = FALSE)
head(data)
```


```{r extract gene lists}

# Ranked gene list vector for GSEA - VECTOR - required for clsuterProfiler
# ranked <- setNames(data$Log2FC[order(-data$Log2FC)], data$Gene.ID[order(-data$Log2FC)])

# dataframe - required for webgestaltr 
ranked <- data %>%
  arrange(desc(Log2FC)) %>%
  dplyr::select(Gene.ID, Log2FC)


head(ranked)
tail(ranked)
```

```{r get vectors for ORA }

# Filter genes with adjusted p-value < 0.01 and absolute log2 fold change > 2
DEGs <- data %>%
  filter(FDR < 0.01, abs(Log2FC) > 2) %>%
  pull(Gene.ID)

# Extract all gene IDs as the background
background <- data %>%
  pull(Gene.ID)


```

```{r}

length(DEGs)
length(background)
```

```{r}
dir.create("WebGestaltR")
```


```{r ORA GO MF nonredundant}

outputDirectory <- "WebGestaltR" 
project <- "ora_GO-MF_non-redundant"
database  <- "geneontology_Molecular_Function_noRedundant"

{ ora_gomf_nr <- WebGestaltR(
    organism = "hsapiens",                   # Use your species (e.g., "hsapiens" for humans)
    enrichMethod = "ORA",                    # Perform ORA, GSEA or NTA
    interestGene = DEGs,                # Your gene list
    interestGeneType = "ensembl_gene_id",         # Specify the gene ID type
    referenceGene = background,                    # Use the default background or provide your own
    referenceGeneType = "ensembl_gene_id",        # Background gene ID type 
    enrichDatabase = database,  # The database for enrichment analysis
    isOutput = TRUE,                        # Set to FALSE if you don't want files saved to disk
    fdrMethod = "BH",                        # Correction method (e.g., Benjamini-Hochberg)
    sigMethod = "fdr",                       # Significance method ('fdr' or 'top')
    fdrThr = 0.05,                           # FDR significance threshold
    minNum = 5,                              # Minimum number of genes per category
    maxNum = 500,                             # Maximum number of genes per category
    boxplot = TRUE,
    outputDirectory = outputDirectory,
    projectName = project
)

}
```

```{r GSEA GO MF nonredundant}

outputDirectory <- "WebGestaltR" 
project <- "gsea_GO-MF_non-redundant"
database  <- "geneontology_Molecular_Function_noRedundant"

{ gsea_gomf_nr <- WebGestaltR(
    organism = "hsapiens",                   # Use your species (e.g., "hsapiens" for humans)
    enrichMethod = "ORA",                    # Perform ORA, GSEA or NTA
    interestGene = DEGs,                # Your gene list
    interestGeneType = "ensembl_gene_id",         # Specify the gene ID type
    referenceGene = background,                    # Use the default background or provide your own
    referenceGeneType = "ensembl_gene_id",        # Background gene ID type 
    enrichDatabase = database,  # The database for enrichment analysis
    isOutput = TRUE,                        # Set to FALSE if you don't want files saved to disk
    fdrMethod = "BH",                        # Correction method (e.g., Benjamini-Hochberg)
    sigMethod = "fdr",                       # Significance method ('fdr' or 'top')
    fdrThr = 0.05,                           # FDR significance threshold
    minNum = 5,                              # Minimum number of genes per category
    maxNum = 500,                             # Maximum number of genes per category
    boxplot = TRUE,
    outputDirectory = outputDirectory,
    projectName = project
)

}
```


```{r nta}

network_gene_sets <- grep("^network", listGeneSet(), value = TRUE)
####### NTA example ######### 

outputDirectory <- "WebGestaltR" 
project <- "gsea_GO-MF_non-redundant"
database  <- "network_PPI_BIOGRID"


WebGestaltR(enrichMethod="NTA",
  organism="hsapiens",
  enrichDatabase=database,
  interestGene=DEGs,
  interestGeneType="ensembl_gene_id",
  sigMethod="top",
  topThr=10,
  outputDirectory=getwd(),
  highlightSeedNum=10,
  networkConstructionMethod="Network_Retrieval_Prioritization")



```


. 


```{r GSEA Reactome }

#rankFile <- system.file("extdata", "GeneRankList.rnk", package="WebGestaltR")

outputDirectory <- "../testing_WebGestaltR" 

#gsea_vector <- setNames(gsea_gene_list$Log2FC, gsea_gene_list$Gene.ID)

enrichResult <- WebGestaltR(enrichMethod="GSEA", 
  organism="hsapiens",
  enrichDatabase="pathway_Reactome",
  interestGene=ranked,
  interestGeneType="ensembl_gene_id",
  sigMethod="top",
  topThr=10,
  minNum=5,
  outputDirectory=outputDirectory)

```
Beautiful!! Output in folder named "Project_1731238499/" - is there a way to change the default naming??

From the HTML report, user can click on the Reactome link for any of the enrichments, and be taken to the Reactome site page for that pathway. 




```{r ORA Reactome }

outputDirectory <- "../testing_WebGestaltR" 
project <- "ora_reactome"

system.time({ wgr_ora_reactome <- WebGestaltR(
    organism = "hsapiens",                   # Use your species (e.g., "hsapiens" for humans)
    enrichMethod = "ORA",                    # Perform ORA, GSEA or NTA
    interestGene = DEGs,                # Your gene list
    interestGeneType = "ensembl_gene_id",         # Specify the gene ID type
    referenceGene = background,                    # Use the default background or provide your own
    referenceGeneType = "ensembl_gene_id",        # Background gene ID type (if using a custom background)
    enrichDatabase = "pathway_Reactome",  # The database for enrichment analysis
    isOutput = TRUE,                        # Set to FALSE if you don't want files saved to disk
    fdrMethod = "BH",                        # Correction method (e.g., Benjamini-Hochberg)
    sigMethod = "fdr",                       # Significance method ('fdr' or 'top')
    fdrThr = 0.05,                           # FDR significance threshold
    minNum = 5,                              # Minimum number of genes per category
    maxNum = 500,                             # Maximum number of genes per category
    boxplot = TRUE,
    outputDirectory = outputDirectory,
    projectName = project
)

})
```
Run WebGestaltR over many databases at once: 

Holy moly its so good 
 
```{r ORA Reactome MANY DBS}
databases <- c("pathway_Reactome", "pathway_KEGG", "pathway_Panther", "pathway_Wikipathway")

outputDirectory <- "../testing_WebGestaltR" 
project <- "ora_reactome_PATHWAYS"

WebGestaltR(
    organism = "hsapiens",                   # Use your species (e.g., "hsapiens" for humans)
    enrichMethod = "ORA",                    # Perform ORA, GSEA or NTA
    interestGene = DEGs,                # Your gene list
    interestGeneType = "ensembl_gene_id",         # Specify the gene ID type
    referenceGene = background,                    # Use the default background or provide your own
    referenceGeneType = "ensembl_gene_id",        # Background gene ID type (if using a custom background)
    enrichDatabase = databases,  # The database for enrichment analysis
    isOutput = TRUE,                        # Set to FALSE if you don't want files saved to disk
    fdrMethod = "BH",                        # Correction method (e.g., Benjamini-Hochberg)
    sigMethod = "fdr",                       # Significance method ('fdr' or 'top')
    fdrThr = 0.05,                           # FDR significance threshold
    minNum = 5,                              # Minimum number of genes per category
    maxNum = 500,                             # Maximum number of genes per category
    boxplot = TRUE,
    outputDirectory = outputDirectory,
    projectName = project
)

```




#### get reactome db version from web and save to notebook 








```{r webgestalt ORA GO MF }

outputDirectory <- getwd() 
project <- "webgestaltR_GOMF"

wg_ora_go_mf <- WebGestaltR(
    organism = "hsapiens",                   # Use your species (e.g., "hsapiens" for humans)
    enrichMethod = "ORA",                    # Perform ORA, GSEA or NTA
    interestGene = ora_gene_list,                # Your gene list
    interestGeneType = "ensembl_gene_id",         # Specify the gene ID type
    referenceGene = background_gene_list,                    # Use the default background or provide your own
    referenceGeneType = "ensembl_gene_id",        # Background gene ID type (if using a custom background)
    enrichDatabase = "geneontology_Molecular_Function",  # The database for enrichment analysis
    isOutput = TRUE,                        # Set to FALSE if you don't want files saved to disk
    fdrMethod = "BH",                        # Correction method (e.g., Benjamini-Hochberg)
    sigMethod = "fdr",                       # Significance method ('fdr' or 'top')
    fdrThr = 0.05,                           # FDR significance threshold
    minNum = 5,                              # Minimum number of genes per category
    maxNum = 500,                             # Maximum number of genes per category
    boxplot = TRUE,
    outputDirectory = outputDirectory,
    projectName = project
)

```





```{r webgestalt ORA GO MF non-redundant }

outputDirectory <- getwd() 
project <- "webgestaltR_GOMF_noRedundant"

wg_ora_go_mf_nr <- WebGestaltR(
    organism = "hsapiens",                   # Use your species (e.g., "hsapiens" for humans)
    enrichMethod = "ORA",                    # Perform ORA, GSEA or NTA
    interestGene = ora_gene_list,                # Your gene list
    interestGeneType = "ensembl_gene_id",         # Specify the gene ID type
    referenceGene = background_gene_list,                    # Use the default background or provide your own
    referenceGeneType = "ensembl_gene_id",        # Background gene ID type (if using a custom background)
    enrichDatabase = "geneontology_Molecular_Function_noRedundant",  # The database for enrichment analysis
    isOutput = TRUE,                        # Set to FALSE if you don't want files saved to disk
    fdrMethod = "BH",                        # Correction method (e.g., Benjamini-Hochberg)
    sigMethod = "fdr",                       # Significance method ('fdr' or 'top')
    fdrThr = 0.05,                           # FDR significance threshold
    minNum = 5,                              # Minimum number of genes per category
    maxNum = 500,                             # Maximum number of genes per category
    boxplot = TRUE,
    outputDirectory = outputDirectory,
    projectName = project
)

```


Maybe a good activity for activity 2: use list organism to work out how to change to mouse, run the 'noRedundant vs redundant'. and compare. show how can minimise false positives. 

Did this for Pezzini ORA GO MF: eg "binding" - there were 85 from the GO MF db and 34 from the GO MF noRedundant set. 

Use R to filter which ones were dropped, and then show the GO hierarchy for one example parent term, show how the signiicant child term remaisn in the "no redundant" - helps to isoalt emore important results 

Compare the enriched terms:

Visulaise the number of unique and shared terms: 

```{r Compare redundant v non-redundant}

nr_terms <- wg_ora_go_mf_nr$geneSet
r_terms <- wg_ora_go_mf$geneSet

# Find unique terms
unique_nr_terms <- setdiff(nr_terms, r_terms)
unique_r_terms <- setdiff(r_terms, nr_terms)

# Display the count of unique terms
cat("Number of unique NR terms:", length(unique_nr_terms), "\n")
cat("Number of unique R terms:", length(unique_r_terms), "\n")

# Display the unique terms themselves
cat("Unique NR terms:\n", unique_nr_terms, "\n")
cat("Unique R terms:\n", unique_r_terms, "\n")
```

Check one of those terms that are unique to NR: 


```{r check unique term}
wg_ora_go_mf_nr[wg_ora_go_mf_nr$geneSet == "GO:0008227", c("geneSet", "description")]
```

```{r review term in redundant}

search <- "G protein-coupled"

wg_ora_go_mf[grep(search, wg_ora_go_mf$description, ignore.case = TRUE), c("geneSet", "description")]
```


```{r now review term in non-redundant}

wg_ora_go_mf_nr[grep(search, wg_ora_go_mf_nr$description, ignore.case = TRUE), c("geneSet", "description")]

```

So we have one term common to both - G protein-coupled receptor binding. Yet 2 terms in the redundant set, and 1 unique term in the non-redundant. How are they related? 


Click Neighborhood

Extract the tables of the erniched terms, names, and FDR:

```{r}
nr_df <- data.frame(
  GeneSet = wg_ora_go_mf_nr$geneSet,
  Description = wg_ora_go_mf_nr$description,
  FDR =wg_ora_go_mf_nr$FDR,
  stringsAsFactors = FALSE  
)


r_df <- data.frame(
  GeneSet = wg_ora_go_mf$geneSet,
  Description = wg_ora_go_mf$description,
  FDR =wg_ora_go_mf$FDR,
  stringsAsFactors = FALSE  
)

write.table(nr_df, "wg_ora_go_mf_nr.tsv", sep = "\t", row.names = TRUE, quote = FALSE)
write.table(r_df, "wg_ora_go_mf.tsv", sep = "\t", row.names = TRUE, quote = FALSE)

```

```{r Plot redundant v non-redundant}

venn.plot <- venn.diagram(
  x = list(Redundant = r_terms, NonRedundant = nr_terms),
  category.names = c("Redundant", "Non-Redundant"),
  filename = NULL,  # Keeps the plot in the R session
  fill = c("cornflowerblue", "lightpink"),
  alpha = 0.5,
  cex = 2,
  cat.cex = 1.5,
  main = "Comparison of Enriched Terms"
)
grid.newpage() # required this, in order to render inside notebook  - library(grid)
grid.draw(venn.plot)

```

Can we check the differences against the GO hierarchy to see what ahs been dropped/collapsed/popped out as unique? 


```{r GSEA example }

#rankFile <- system.file("extdata", "GeneRankList.rnk", package="WebGestaltR")

outputDirectory <- getwd() 

#gsea_vector <- setNames(gsea_gene_list$Log2FC, gsea_gene_list$Gene.ID)

enrichResult <- WebGestaltR(enrichMethod="GSEA", 
  organism="hsapiens",
  enrichDatabase="pathway_KEGG",
  interestGene=gsea_gene_list,
  interestGeneType="ensembl_gene_id",
  sigMethod="top",
  topThr=10,
  minNum=5,
  outputDirectory=outputDirectory)

```



``` {r NTA example }

####### NTA example ######### 
enrichResult <- WebGestaltR(enrichMethod="NTA",
  organism="hsapiens",
  enrichDatabase="network_PPI_BIOGRID",
  interestGene=ora_gene_list,
  interestGeneType="ensembl_gene_id",
  sigMethod="top",
  topThr=10,
  outputDirectory=getwd(),
  highlightSeedNum=10,
  networkConstructionMethod="Network_Retrieval_Prioritization")



```


